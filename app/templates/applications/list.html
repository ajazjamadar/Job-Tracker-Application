{% extends 'layout.html' %}

{% block title %}Applications - Job Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-list-ul"></i> All Applications</h1>
  <a href="{{ url_for('main.new_application') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Add Application
  </a>
</div>

<!-- Search Form -->
<div class="card mb-3">
  <div class="card-body">
    <form method="get" action="{{ url_for('main.applications_list') }}" class="row g-3">
      <div class="col-md-5">
        <label for="company" class="form-label">Search by Company</label>
        <input type="text" class="form-control" id="company" name="company" 
               value="{{ q_company or '' }}" placeholder="Enter company name...">
      </div>
      <div class="col-md-3">
        <label for="status" class="form-label">Filter by Status</label>
        <select class="form-select" id="status" name="status">
          <option value="">All Statuses</option>
          <option value="Applied" {% if q_status == 'Applied' %}selected{% endif %}>Applied</option>
          <option value="Interview" {% if q_status == 'Interview' %}selected{% endif %}>Interview</option>
          <option value="Offer" {% if q_status == 'Offer' %}selected{% endif %}>Offer</option>
          <option value="Accepted" {% if q_status == 'Accepted' %}selected{% endif %}>Accepted</option>
          <option value="Rejected" {% if q_status == 'Rejected' %}selected{% endif %}>Rejected</option>
          <option value="Withdrawn" {% if q_status == 'Withdrawn' %}selected{% endif %}>Withdrawn</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
          <i class="bi bi-search"></i> Search
        </button>
        {% if q_company or q_status %}
          <a href="{{ url_for('main.applications_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Clear
          </a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

{% if pagination.items %}
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Company</th>
              <th>Position</th>
              <th>Status</th>
              <th>Date Applied</th>
              <th>Follow-up Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for app in pagination.items %}
              <tr>
                <td><strong>{{ app.company }}</strong></td>
                <td>{{ app.position or '-' }}</td>
                <td>
                  {% if app.status == 'Applied' %}
                    <span class="badge bg-info">{{ app.status }}</span>
                  {% elif app.status == 'Interview' %}
                    <span class="badge bg-warning text-dark">{{ app.status }}</span>
                  {% elif app.status == 'Offer' %}
                    <span class="badge bg-success">{{ app.status }}</span>
                  {% elif app.status == 'Accepted' %}
                    <span class="badge bg-success">{{ app.status }}</span>
                  {% elif app.status == 'Rejected' %}
                    <span class="badge bg-danger">{{ app.status }}</span>
                  {% elif app.status == 'Withdrawn' %}
                    <span class="badge bg-secondary">{{ app.status }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ app.status }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if app.date_applied %}
                    <small>{{ app.date_applied.strftime('%b %d, %Y') }}</small>
                  {% else %}
                    <small class="text-muted">-</small>
                  {% endif %}
                </td>
                <td>
                  {% if app.follow_up_date %}
                    <small>{{ app.follow_up_date.strftime('%b %d, %Y') }}</small>
                  {% else %}
                    <small class="text-muted">-</small>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{{ url_for('main.edit_application', app_id=app.id) }}" 
                       class="btn btn-outline-primary" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-outline-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteModal{{ app.id }}"
                            title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  
                  <!-- Delete Confirmation Modal -->
                  <div class="modal fade" id="deleteModal{{ app.id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Confirm Delete</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete the application for <strong>{{ app.company }}</strong>?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="{{ url_for('main.delete_application', app_id=app.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-danger">
                              <i class="bi bi-trash"></i> Delete
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% if app.notes %}
                <tr class="table-light">
                  <td colspan="6">
                    <small class="text-muted">
                      <i class="bi bi-sticky"></i> <strong>Notes:</strong> {{ app.notes }}
                    </small>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        <!-- Previous Page -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{% if pagination.has_prev %}{{ url_for('main.applications_list', page=pagination.prev_num, company=q_company, status=q_status) }}{% else %}#{% endif %}">
            <i class="bi bi-chevron-left"></i> Previous
          </a>
        </li>
        
        <!-- Page Numbers -->
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if page_num %}
            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('main.applications_list', page=page_num, company=q_company, status=q_status) }}">
                {{ page_num }}
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        
        <!-- Next Page -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{% if pagination.has_next %}{{ url_for('main.applications_list', page=pagination.next_num, company=q_company, status=q_status) }}{% else %}#{% endif %}">
            Next <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <!-- Results Info -->
  <div class="mt-3 text-center text-muted">
    <small>
      Showing {{ pagination.items|length }} of {{ pagination.total }} application(s)
      {% if q_company or q_status %}
        matching filters
        {% if q_company %}"{{ q_company }}"{% endif %}
        {% if q_status %}[{{ q_status }}]{% endif %}
      {% endif %}
      (Page {{ pagination.page }} of {{ pagination.pages }})
    </small>
  </div>

{% else %}
  <!-- Empty State -->
  <div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    {% if q_company or q_status %}
      <h3 class="mt-3 text-muted">No Results Found</h3>
      <p class="text-muted mb-4">
        No applications found matching 
        {% if q_company %}"{{ q_company }}"{% endif %}
        {% if q_status %}[{{ q_status }}]{% endif %}
      </p>
      <a href="{{ url_for('main.applications_list') }}" class="btn btn-outline-primary">
        <i class="bi bi-x-circle"></i> Clear Search
      </a>
    {% else %}
      <h3 class="mt-3 text-muted">No Applications Yet</h3>
      <p class="text-muted mb-4">Start tracking your job applications.</p>
      <a href="{{ url_for('main.new_application') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle"></i> Add Your First Application
      </a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}